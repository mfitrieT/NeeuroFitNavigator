<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do something</title>
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap@4.1.3/dist/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css">
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="lodash.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.15/lodash.min.js"></script>
    <script src="https://unpkg.com/vue@2.7.10/dist/vue.js"></script>
    <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>

<body>
    <div id="app" style="font-family: undefined;">Assesment click</div>
    <script id="appTemplate" type="text/template">
        <b-container>
            <b-row class="mb-4">
                <b-col>
                    <b-button @click="navToAssessment">Click to do {{ entity.client_name }}'s Assessment</b-button>
                </b-col>
            </b-row>
            <b-row class="mb-4">
                <b-col class="col-12">
                    <span class="font-weight-bold" style="font-size: 1.2rem;">NeeuroFit Account Creation</span>
                </b-col>
                <b-col class="col-6">
                    <b-form-group
                        id="form-neeurofit-start-date"
                        label="Start Date"
                        label-for="input-neeurofit-start-date"
                    >
                        <b-form-input id="input-neeurofit-start-date" type="date"></b-form-input>
                    </b-form-group>
                </b-col>
                <b-col class="col-6">
                    <b-form-group
                        id="form-neeurofit-end-date"
                        label="End Date"
                        label-for="input-neeurofit-end-date"
                    >
                        <b-form-input id="input-neeurofit-end-date" type="date" :disabled="true"></b-form-input>
                    </b-form-group>
                </b-col>
                <b-col class="col-12">
                    <b-button @click="sendNeeuroFitEmailAccountCreation" variant="success" disabled>Create NeeuroFit Account {{ entity.client_name }}'s Assessment</b-button>
                </b-col>
            </b-row>
            <b-row class="mb-4">
                <b-col class="col-12">
                    <span class="font-weight-bold" style="font-size: 1.2rem;">NeeuroFit Account Renewal</span>
                </b-col>
                <b-col class="col-6">
                    <b-form-group
                        id="form-neeurofit-renew-start-date"
                        label="Start Date"
                        label-for="input-neeurofit-renew-start-date"
                    >
                        <b-form-input id="input-neeurofit-renew-start-date" type="date"></b-form-input>
                    </b-form-group>
                </b-col>
                <b-col class="col-6">
                    <b-form-group
                        id="form-neeurofit-renew-end-date"
                        label="End Date"
                        label-for="input-neeurofit-renew-end-date"
                    >
                        <b-form-input id="input-neeurofit-renew-end-date" type="date" :disabled="true"></b-form-input>
                    </b-form-group>
                </b-col>
                <b-col class="col-12">
                    <b-button variant="success" @click="sendNeeuroFitEmailAccountDeactivation" disabled>Renew NeeuroFit Account {{ entity.client_name }}'s Assessment</b-button>
                </b-col>
            </b-row>
            <b-row>
                <b-col class="col-12">
                    <span class="font-weight-bold" style="font-size: 1.2rem;">NeeuroFit Account Deactivation</span>
                </b-col>
                <b-col class="col-6">
                    <b-form-group
                        id="form-neeurofit-deactivate-date"
                        label="Date Deactivation"
                        label-for="input-neeurofit-deactivate-date"
                    >
                        <b-form-input id="input-neeurofit-deactivate-date" type="date"></b-form-input>
                    </b-form-group>
                </b-col>
                <b-col class="col-12">
                    <b-button variant="danger" @click="sendNeeuroFitEmailAccountDeactivation" disabled>Deactivate NeeuroFit Account {{ entity.client_name }}'s Assessment</b-button>
                </b-col>
            </b-row>
        </b-container>
    </script>
    <script>
        const transformData = raw => {
            if (!raw) {
                return null;
            }
            return {
                client_name: raw.crb5c_no,
                gender: raw.crb5c_sex,
            }
        }

        window.addEventListener("load", async () => {

            let entityId = window.top.Xrm.Page.data.entity.getId();
            let entityLogicalName = "crb5c_fow_customer";
            let options = new URLSearchParams({
                $select: 'crb5c_no, crb5c_sex',
                $filter: `crb5c_fow_customerid eq '${entityId}'`,
            });

            let { entities } = await window.top.Xrm.WebApi.retrieveMultipleRecords(entityLogicalName, '?' + options.toString());
            let entity = transformData(entities[0]);

            const app = new Vue({
                el: "#app",
                template: "#appTemplate",
                data() {
                    return {
                        entity,
                        clientid: '',
                    }
                },
                methods: {
                    navToAssessment() {
                        console.log('ID:', entityId)
                        finalUrl = `https://fow-assessment-test.npo.sg/home/?client_id=${entityId}`;
                        window.open(finalUrl);
                    },
                    async sendNeeuroFitEmailAccountCreation(){
                        try {
                            const BASE_URL_NEEUROFIT_ACCOUNT_CREATION_EMAIL = "https://prod.dx0vjh7tbhwvp.amplifyapp.com/api/emailNeeurofitAccountCreation";
                            const LIST_GENDER = ["Male", "Female"];

                            const clientGender = LIST_GENDER[entity.gender];
                            
                            console.log("sendNeeuroFitEmailAccountCreation ");
    
                            const payload = {
                                // TODO: remove (TEST) when live
                                subject: `NeeuroFit Account Creation for ${this.entity.client_name} (TEST)`,
                                messageBody: [
                                    "Hi Kwee Eng",
                                    "New NeeuroFit account:",
                                    `Name: ${this.entity.client_name}`,
                                    `Email: DSG23001@edenlab.com`,
                                    // FIX; put actual date of birth data
                                    `Date of birth: 1/2/1968`,
                                    `Gender: ${clientGender}`,
                                    "Warm Regards,"
                                ],
                                footer: [
                                    "Eunice Tan  (Ms)",
                                    "Manager | Family of Wisdom (Bendemeer)",
                                    "20 Bendemeer Road, #01-02, BS Bendemeer Centre, Singapore 339914",
                                    "DID: 6389 5385 | Fax: 6293 6631| "
                                ],
                                footerLink: "http://www.alz.org.sg",
                                senderEmail: "neeurofit-reports@dementia.org.sg",
                                // TODO: comment when live
                                // receiverEmail: "mfitrie789@yahoo.com",
                                // CCEmail: ["m.fitrie@thunderquote.com"],
                                // TODO: comment when live
                                // TODO: uncomment when live
                                receiverEmail: "robin_a12@hotmail.com",
                                CCEmail: ['eunice.tan@dementia.org.sg', 'guanlai.choo@dementia.org.sg']
                                // TODO: uncomment when live
                            }

                            axios.post(BASE_URL_NEEUROFIT_ACCOUNT_CREATION_EMAIL, payload);

                            
                        } catch (error) {
                            console.error(error);
                            alert("Sending NeeuroFit account creation failed")
                        }

                    },
                    async sendNeeuroFitEmailAccountDeactivation(){
                        try {
                            const BASE_URL_NEEUROFIT_ACCOUNT_DEACTIVATION_EMAIL = "https://prod.dx0vjh7tbhwvp.amplifyapp.com/api/emailNeeurofitAccountCreation/account-deactivation";

                            const payload = {
                                // TODO: remove (TEST) when live
                                subject: `NeeuroFit Account Deactivation for ${this.entity.client_name} (TEST)`,
                                messageBody: [
                                        "Hi Kwee Eng",
                                        "NeeuroFit Account Deactivation:",
                                        `Name: ${this.entity.client_name}`,
                                        "Email: DSG23001@edenlab.com",
                                        "Warm Regards,"
                                    ],
                                footer: [
                                        "Eunice Tan  (Ms)",
                                        "Manager | Family of Wisdom (Bendemeer)",
                                        "20 Bendemeer Road, #01-02, BS Bendemeer Centre, Singapore 339914",
                                        "DID: 6389 5385 | Fax: 6293 6631| "
                                    ],
                                footerLink: "http://www.alz.org.sg",
                                senderEmail: "neeurofit-reports@dementia.org.sg",
                                // TODO: comment when live
                                // receiverEmail: "mfitrie789@yahoo.com",
                                // CCEmail: ["m.fitrie@thunderquote.com"],
                                // TODO: comment when live
                                // TODO: uncomment when live
                                receiverEmail: "robin_a12@hotmail.com",
                                CCEmail: ['eunice.tan@dementia.org.sg', 'guanlai.choo@dementia.org.sg']
                                // TODO: uncomment when live
                            }

                            axios.post(BASE_URL_NEEUROFIT_ACCOUNT_DEACTIVATION_EMAIL, payload);
                            
                        } catch (error) {
                            console.error(error);
                            alert("Sending NeeuroFit account deactivation failed")
                        }
                    }
                },
            })
        });

    </script>
    <style lang="scss" scoped="">
        .headertitle {
            font-size: 22px;
            padding: 30px;
            text-align: center;
        }

        .colcolor {
            background: rgba(80, 39, 107, 0.728);
            color: white;
            text-align: center;
        }

        .darkcolcolor {
            background: rgba(80, 39, 107, 0.728);
            color: white;
        }

        .row-center {
            text-align: center;
        }
    </style>

</body>

</html>